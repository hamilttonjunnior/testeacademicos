<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acad√™micos - Gest√£o em Nuvem</title>
    <style>
        :root { --primary: #1a2a3a; --accent: #3498db; --error: #e74c3c; --success: #27ae60; --bg: #f4f7f9; --finished: #bdc3c7; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        /* TELA DE LOGIN */
        #loginScreen { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 320px; }
        .login-logo { max-width: 150px; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
        .login-box input, .login-box button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; box-sizing: border-box; }
        .login-box input { border: 1px solid #ddd; }
        .login-box button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; }
        
        /* DASHBOARD */
        .main-content { width: 95%; max-width: 1200px; margin: 20px auto; display: none; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .header-logo { max-height: 50px; margin-right: 15px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; background: #fafafa; padding: 20px; border-radius: 8px; border: 1px solid #eaeaea; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        .field label { font-size: 12px; font-weight: bold; color: #666; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        .btn-marcar { grid-column: 1 / -1; padding: 15px; background: var(--success); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* TABELA */
        .table-wrapper { margin-top: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        
        /* ESTADOS DOS JOGOS */
        .row-conflito { background-color: #fff5f5 !important; }
        .row-finalizado { background-color: #f2f4f5 !important; color: #7f8c8d !important; text-decoration: none; }
        .row-finalizado td { border-bottom: 1px solid #dfe6e9; }
        
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: 800; }
        .badge-casa { background: #d1ecf1; color: #0c5460; }
        .badge-fora { background: #e2e3e5; color: #383d41; }
        .badge-pendente { background: #fff3cd; color: #856404; }
        .badge-finalizado { background: #bdc3c7; color: white; }
        
        .error-tag { color: var(--error); font-size: 11px; display: block; font-weight: bold; }
        .btn-action { background: none; border: 1px solid #ddd; padding: 5px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn-finalizar { background: var(--accent); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-finalizar:hover { background: #2980b9; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <img src="academicos.PNG" alt="Logo Acad√™micos" class="login-logo">
        
        <p>Acesso Compartilhado</p>
        <input type="text" id="userIn" placeholder="Usu√°rio">
        <input type="password" id="passIn" placeholder="Senha">
        <button onclick="checkLogin()">Entrar</button>
    </div>
</div>

<div class="main-content" id="app">
    <div class="container">
        <header>
            <div style="display: flex; align-items: center;">
                <img src="academicos.PNG" alt="Logo Acad√™micos" class="header-logo">
                <h2 style="margin:0;">üìÖ Gest√£o de Jogos</h2>
            </div>
            <button onclick="location.reload()" style="cursor:pointer;">Sair</button>
        </header>

        <div class="form-grid">
            <div class="field"><label>Treinador</label><input type="text" id="treinador"></div>
            <div class="field"><label>Cor</label><input type="color" id="cor" value="#3498db"></div>
            <div class="field"><label>Localiza√ß√£o</label>
                <select id="casaFora">
                    <option value="Casa">Casa üè†</option>
                    <option value="Fora">Fora üöå</option>
                </select>
            </div>
            <div class="field"><label>Data</label><input type="date" id="data"></div>
            <div class="field"><label>Hora</label><input type="time" id="hora"></div>
            <div class="field"><label>Escal√£o</label>
                <select id="escalao">
                    <option value="">Selecione o escal√£o...</option>
                    <option value="Infantis A Fem">Infantis A Fem</option>
                    <option value="Infantis B Fem">Infantis B Fem</option>
                    <option value="Infantis C Fem">Infantis C Fem</option>
                    <option value="Iniciados A Fem">Iniciados A Fem</option>
                    <option value="Iniciados B Fem">Iniciados B Fem</option>
                    <option value="Iniciados Masc">Iniciados Masc</option>
                    <option value="Cadetes Fem">Cadetes Fem</option>
                    <option value="Cadetes Masc">Cadetes Masc</option>
                    <option value="Juvenis A Fem">Juvenis A Fem</option>
                    <option value="Juvenis B Fem">Juvenis B Fem</option>
                    <option value="Juvenis Masc">Juvenis Masc</option>
                    <option value="Sub21 Fem">Sub21 Fem</option>
                    <option value="S√©niores Fem">S√©niores Fem</option>
                    <option value="S√©niores Masc">S√©niores Masc</option>
                    <option value="Veteranos +35 Masc">Veteranos +35 Masc</option>
                    <option value="Veteranos +45 Masc">Veteranos +45 Masc</option>
                </select>
            </div>
            <div class="field"><label>Advers√°rio</label><input type="text" id="adversario"></div>
            <div class="field"><label>Pavilh√£o</label><input type="text" id="pavilhao"></div>
            <button class="btn-marcar" id="btnSalvar" onclick="salvarJogo()">AGENDAR / ATUALIZAR JOGO</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th></th><th>Treinador</th><th>Escal√£o</th><th>Advers√°rio</th><th>Data/Hora</th><th>Pavilh√£o</th><th>Tipo</th><th>A√ß√µes</th></tr>
                </thead>
                <tbody id="lista"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Configura√ß√£o do seu Firebase Academicos
    const firebaseConfig = {
        apiKey: "AIzaSyB86TeZnp2qdOXXwjvD3hFfzTi3Z3NkVMc",
        authDomain: "academicos-d2cfc.firebaseapp.com",
        projectId: "academicos-d2cfc",
        storageBucket: "academicos-d2cfc.firebasestorage.app",
        messagingSenderId: "550824625713",
        appId: "1:550824625713:web:f3194f8e4f06dc141a3710"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const jogosCol = collection(db, "jogos");

    let jogosAtuais = [];
    let editId = null;

    window.checkLogin = () => {
        if(document.getElementById('userIn').value === 'academicos' && document.getElementById('passIn').value === 'academicos2026') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            carregarJogos();
        } else { alert("Senha incorreta!"); }
    };

    window.salvarJogo = async () => {
        const btn = document.getElementById('btnSalvar');
        btn.disabled = true;
        btn.innerText = "Processando...";

        const dados = {
            treinador: document.getElementById('treinador').value,
            cor: document.getElementById('cor').value,
            casaFora: document.getElementById('casaFora').value,
            data: document.getElementById('data').value,
            hora: document.getElementById('hora').value,
            escalao: document.getElementById('escalao').value,
            adversario: document.getElementById('adversario').value,
            pavilhao: document.getElementById('pavilhao').value,
            timestamp: Date.now(),
            finalizado: false // Novo campo padr√£o
        };

        try {
            if(editId) {
                await updateDoc(doc(db, "jogos", editId), dados);
                editId = null;
            } else {
                await addDoc(jogosCol, dados);
            }
            limpar();
        } catch (e) { alert("Erro ao salvar!"); }
        
        btn.disabled = false;
        btn.innerText = "AGENDAR / ATUALIZAR JOGO";
    };

    // Fun√ß√£o para Finalizar o Jogo (Exige Senha)
    window.finalizarJogoPrompt = async (id) => {
        const confirmacao = prompt("O hor√°rio do jogo j√° passou. Para mover para o hist√≥rico e bloquear edi√ß√µes, digite a senha:");
        if (confirmacao === "academicos2026") {
            try {
                await updateDoc(doc(db, "jogos", id), { finalizado: true });
            } catch (e) { alert("Erro ao finalizar o jogo."); }
        } else if (confirmacao !== null) {
            alert("Senha incorreta.");
        }
    };

    function carregarJogos() {
        const q = query(jogosCol, orderBy("data"), orderBy("hora"));
        onSnapshot(q, (snapshot) => {
            jogosAtuais = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render();
        });
    }

    function render() {
        const lista = document.getElementById('lista');
        lista.innerHTML = '';
        const agora = new Date();
        
        // 1. Reset conflitos
        jogosAtuais.forEach(j => j.conflito = false);
        
        // 2. Validar conflitos (ignora jogos finalizados)
        for (let i = 0; i < jogosAtuais.length; i++) {
            for (let j = i + 1; j < jogosAtuais.length; j++) {
                let a = jogosAtuais[i], b = jogosAtuais[j];
                // S√ì VALIDA SE AMBOS N√ÉO ESTIVEREM FINALIZADOS
                if(!a.finalizado && !b.finalizado && a.casaFora === 'Casa' && b.casaFora === 'Casa' && a.data && b.data && a.hora && b.hora && a.data === b.data) {
                    let diff = Math.abs(new Date(a.data+'T'+a.hora) - new Date(b.data+'T'+b.hora)) / 60000;
                    if(diff < 120) { a.conflito = true; b.conflito = true; }
                }
            }
        }

        jogosAtuais.forEach(j => {
            const tr = document.createElement('tr');
            const dataFormatada = j.data ? j.data.split('-').reverse().join('/') : '---';
            const horaFormatada = j.hora || '--:--';
            const isFinalizado = j.finalizado === true;
            
            // L√≥gica para mostrar o bot√£o "Finalizar Jogo"
            let mostrarBotaoFinalizar = false;
            if (!isFinalizado && j.data && j.hora) {
                const horarioJogo = new Date(`${j.data}T${j.hora}`);
                if (agora > horarioJogo) {
                    mostrarBotaoFinalizar = true;
                }
            }

            // Classes visuais
            if(isFinalizado) tr.className = 'row-finalizado';
            else if(j.conflito) tr.className = 'row-conflito';

            // Badge de status
            let badgeClass = '';
            let statusTexto = j.casaFora;
            if (isFinalizado) {
                badgeClass = 'badge-finalizado';
                statusTexto = "Finalizado ‚úîÔ∏è";
            } else if (!j.data || !j.hora) {
                badgeClass = 'badge-pendente';
            } else {
                badgeClass = j.casaFora === 'Casa' ? 'badge-casa' : 'badge-fora';
            }

            tr.innerHTML = `
                <td style="background:${j.cor}; width:6px;"></td>
                <td style="font-weight:bold; color:${isFinalizado ? '#7f8c8d' : j.cor}">${j.treinador}</td>
                <td>${j.escalao}</td><td>${j.adversario}</td>
                <td>
                    ${dataFormatada} √†s ${horaFormatada} 
                    ${j.conflito && !isFinalizado ? '<span class="error-tag">‚ö†Ô∏è Conflito Casa (2h)</span>' : ''}
                    ${mostrarBotaoFinalizar ? `<br><button class="btn-finalizar" onclick="finalizarJogoPrompt('${j.id}')">üèÅ Finalizar Jogo</button>` : ''}
                </td>
                <td>${j.pavilhao || '---'}</td>
                <td><span class="badge ${badgeClass}">${statusTexto}</span></td>
                <td>
                    ${!isFinalizado ? `<button class="btn-action" onclick="prepararEdicao('${j.id}')">‚úèÔ∏è</button>` : 'üîí'}
                    <button class="btn-action" onclick="eliminarJogo('${j.id}')">üóëÔ∏è</button>
                </td>`;
            lista.appendChild(tr);
        });
    }

    window.prepararEdicao = (id) => {
        const j = jogosAtuais.find(x => x.id === id);
        if (j.finalizado) { alert("Este jogo j√° foi finalizado e n√£o pode ser editado."); return; }
        document.getElementById('treinador').value = j.treinador;
        document.getElementById('cor').value = j.cor;
        document.getElementById('casaFora').value = j.casaFora;
        document.getElementById('data').value = j.data;
        document.getElementById('hora').value = j.hora;
        document.getElementById('escalao').value = j.escalao;
        document.getElementById('adversario').value = j.adversario;
        document.getElementById('pavilhao').value = j.pavilhao;
        editId = id; window.scrollTo(0,0);
    };

    window.eliminarJogo = async (id) => {
        const confirmacao = prompt("Para eliminar este jogo (mesmo que finalizado), digite a senha:");
        if (confirmacao === "academicos2026") {
            await deleteDoc(doc(db, "jogos", id));
        } else if (confirmacao !== null) {
            alert("Senha incorreta!");
        }
    };

    function limpar() { 
        ['data','hora','adversario','pavilhao'].forEach(id => document.getElementById(id).value = '');
    }
</script>
</body>
</html>


